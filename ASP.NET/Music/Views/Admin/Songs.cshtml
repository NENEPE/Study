@using MusicPortal.Models
@model IndexViewModel

@{
    ViewData["Title"] = Resources.Resource.Songs;
}

<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-file-audio me-2"></i>@Resources.Resource.Songs
        </h1>
        <a href="@Url.Action("Index", "Admin")" class="d-none d-sm-inline-block btn btn-sm btn-secondary shadow-sm">
            <i class="fas fa-arrow-left me-1"></i>@Resources.Resource.BackTo
        </a>
    </div>

    @* --- 1. Filter Section --- *@
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            @* Added the Total Count Badge here *@
            <span class="badge bg-primary">@ViewBag.TotalSongsCount @Resources.Resource.TotalSongs</span>

            <form method="get" asp-action="Songs" class="row g-3 align-items-end m-0">
                <div class="col-auto">
                    <label class="visually-hidden">@Resources.Resource.Genre</label>
                    <select name="genre" asp-items="Model.FilterViewModel.Genres" class="form-select form-select-sm"></select>
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="fas fa-filter me-1"></i> @Resources.Resource.Filter
                    </button>
                </div>
            </form>
        </div>

        <div class="card-body">
            @if (!Model.Songs.Any())
            {
                <div class="text-center py-4">
                    <i class="fas fa-music fa-3x text-gray-300 mb-3"></i>
                    <h5 class="text-gray-500">@Resources.Resource.NoSongs</h5>
                    <a href="@Url.Action("Create", "Song")" class="btn btn-primary mt-2">
                        <i class="fas fa-plus me-1"></i>@Resources.Resource.CreateSong
                    </a>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="songsTable" width="100%" cellspacing="0">
                        <thead class="table-dark">
                            <tr>
                                @* --- 2. Sorting Headers (Updated asp-action="Songs") --- *@
                                <th>
                                    <a asp-action="Songs"
                                       asp-route-sortOrder="@Model.SortViewModel.TitleSort"
                                       asp-route-genre="@Model.FilterViewModel.SelectedGenre"
                                       class="text-white text-decoration-none d-flex justify-content-between align-items-center">
                                        @Resources.Resource.SongTitle
                                        @if (Model.SortViewModel.Current == SortState.TitleAsc)
                                        {
                                            <i class="fas fa-sort-up"></i>
                                        }
                                        else if (Model.SortViewModel.Current == SortState.TitleDesc)
                                        {
                                            <i class="fas fa-sort-down"></i>
                                        }
                                        else
                                        {
                                            <i class="fas fa-sort text-gray-500" style="opacity:0.3"></i>
                                        }
                                    </a>
                                </th>
                                <th>
                                    <a asp-action="Songs"
                                       asp-route-sortOrder="@Model.SortViewModel.ArtistSort"
                                       asp-route-genre="@Model.FilterViewModel.SelectedGenre"
                                       class="text-white text-decoration-none d-flex justify-content-between align-items-center">
                                        @Resources.Resource.Artist
                                        @if (Model.SortViewModel.Current == SortState.ArtistAsc)
                                        {
                                            <i class="fas fa-sort-up"></i>
                                        }
                                        else if (Model.SortViewModel.Current == SortState.ArtistDesc)
                                        {
                                            <i class="fas fa-sort-down"></i>
                                        }
                                        else
                                        {
                                            <i class="fas fa-sort text-gray-500" style="opacity:0.3"></i>
                                        }
                                    </a>
                                </th>
                                <th>
                                    <a asp-action="Songs"
                                       asp-route-sortOrder="@Model.SortViewModel.GenreSort"
                                       asp-route-genre="@Model.FilterViewModel.SelectedGenre"
                                       class="text-white text-decoration-none d-flex justify-content-between align-items-center">
                                        @Resources.Resource.Genre
                                        @if (Model.SortViewModel.Current == SortState.GenreAsc)
                                        {
                                            <i class="fas fa-sort-up"></i>
                                        }
                                        else if (Model.SortViewModel.Current == SortState.GenreDesc)
                                        {
                                            <i class="fas fa-sort-down"></i>
                                        }
                                        else
                                        {
                                            <i class="fas fa-sort text-gray-500" style="opacity:0.3"></i>
                                        }
                                    </a>
                                </th>
                                <th>@Resources.Resource.UploadedBy</th>
                                <th>
                                    <a asp-action="Songs"
                                       asp-route-sortOrder="@Model.SortViewModel.DateSort"
                                       asp-route-genre="@Model.FilterViewModel.SelectedGenre"
                                       class="text-white text-decoration-none d-flex justify-content-between align-items-center">
                                        @Resources.Resource.Date
                                        @if (Model.SortViewModel.Current == SortState.DateAsc)
                                        {
                                            <i class="fas fa-sort-up"></i>
                                        }
                                        else if (Model.SortViewModel.Current == SortState.DateDesc)
                                        {
                                            <i class="fas fa-sort-down"></i>
                                        }
                                        else
                                        {
                                            <i class="fas fa-sort text-gray-500" style="opacity:0.3"></i>
                                        }
                                    </a>
                                </th>
                                <th>@Resources.Resource.Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @* --- 3. Data Loop --- *@
                            @foreach (var song in Model.Songs)
                            {
                                <tr>
                                    <td>
                                        <strong>@song.Title</strong>
                                        @if (!string.IsNullOrEmpty(song.Description))
                                        {
                                            <br />
                                            <small class="text-muted">@song.Description</small>
                                        }
                                    </td>
                                    <td>@song.Artist</td>
                                    <td>
                                        <span class="badge bg-secondary">@song.Genre?.Name</span>
                                    </td>
                                    <td>@(song.User != null ? song.User.Username : "Unknown")</td>
                                    <td>@song.UploadDate.ToString("MMM dd, yyyy")</td>
                                    <td>
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="btn-group btn-group-sm">
                                                <a href="@Url.Action("Download", "Song", new { id = song.Id })"
                                                   class="btn btn-info" title="@Resources.Resource.Download">
                                                    <i class="fas fa-download"></i>
                                                </a>
                                                <form method="post" action="@Url.Action("DeleteSong", "Admin")" class="d-inline">
                                                    <input type="hidden" name="id" value="@song.Id" />
                                                    @Html.AntiForgeryToken()
                                                    <button type="submit" class="btn btn-danger"
                                                            title="@Resources.Resource.Delete"
                                                            onclick="return confirm('Are you sure you want to delete this song?');">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                        @* Optional: Audio player *@
                                        <div class="mt-2">
                                            <audio controls style="height: 25px; width: 100%;">
                                                <source src="@song.FilePath">
                                            </audio>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                @* --- 4. Pagination Section (Updated asp-action="Songs") --- *@
                <div class="d-flex justify-content-center mt-4">
                    <nav aria-label="Page navigation">
                        <ul class="pagination">
                            @if (Model.PageViewModel.HasPreviousPage)
                            {
                                <li class="page-item">
                                    <a asp-action="Songs"
                                       asp-route-page="@(Model.PageViewModel.PageNumber - 1)"
                                       asp-route-sortOrder="@Model.SortViewModel.Current"
                                       asp-route-genre="@Model.FilterViewModel.SelectedGenre"
                                       class="page-link">
                                        <i class="fas fa-chevron-left"></i>
                                    </a>
                                </li>
                            }
                            else
                            {
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-chevron-left"></i></span>
                                </li>
                            }

                            <li class="page-item disabled">
                                <span class="page-link bg-light text-dark">
                                    @Model.PageViewModel.PageNumber / @Model.PageViewModel.TotalPages
                                </span>
                            </li>

                            @if (Model.PageViewModel.HasNextPage)
                            {
                                <li class="page-item">
                                    <a asp-action="Songs"
                                       asp-route-page="@(Model.PageViewModel.PageNumber + 1)"
                                       asp-route-sortOrder="@Model.SortViewModel.Current"
                                       asp-route-genre="@Model.FilterViewModel.SelectedGenre"
                                       class="page-link">
                                        <i class="fas fa-chevron-right"></i>
                                    </a>
                                </li>
                            }
                            else
                            {
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-chevron-right"></i></span>
                                </li>
                            }
                        </ul>
                    </nav>
                </div>
            }
        </div>
    </div>
</div>